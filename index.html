<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>copyflow</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <div class="header">
        <div class="project-selector">
            <h1>copyflow</h1>
            <select id="projectSelect" onchange="switchProject()">
                <option value="">Select a project...</option>
            </select>
            <button onclick="showProjectOverview()">
                All Projects
            </button>
            <button onclick="openProjectModal()">
                New Project
            </button>
            <button onclick="toggleArchivedProjects()" id="archiveToggle" style="display: none;">
                Show Archived
            </button>
            <button id="projectSettingsBtn" onclick="openProjectSettings()" style="display: none;">
                Settings
            </button>
            
            <!-- Help Button - add this near other navigation buttons -->
<button onclick="showHelp()" style="
    background: #f3f4f6; 
    border: 1px solid #d1d5db; 
    border-radius: 4px; 
    width: 32px; 
    height: 32px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    cursor: pointer; 
    font-size: 16px; 
    font-weight: 600;
    color: #374151;
" title="Help (F1)">?
</button>
            
        </div>
    </div>

    <!-- Breadcrumb Trail -->
    <div class="breadcrumb-container" id="breadcrumbContainer" style="display: none;">
        <div class="breadcrumb-trail" id="breadcrumbTrail"></div>
    </div>

    <!-- Project Overview -->
    <div class="project-overview" id="projectOverview">
        <div class="overview-layout">
            <div>
                <div class="project-grid" id="projectGrid"></div>
            </div>
            <div class="global-tasks-panel">
                <div class="global-tasks-header">
                    <h3>Global Tasks</h3>
                </div>
                
                <div class="top-three-section">
                    <div class="top-three-header">
                        Top 3 Priority Tasks
                    </div>
                    <div id="topThreeTasks" class="task-drop-zone" 
                         ondrop="handleTaskDrop(event, 'top-three')" 
                         ondragover="handleTaskDragOver(event)"
                         ondragleave="handleTaskDragLeave(event)">
                        Drop your most important tasks here
                    </div>
                </div>
                
                <div class="other-tasks-section">
                    <div class="other-tasks-header">All Other Tasks</div>
                    <div id="otherTasks" class="task-drop-zone"
                         ondrop="handleTaskDrop(event, 'other')" 
                         ondragover="handleTaskDragOver(event)"
                         ondragleave="handleTaskDragLeave(event)">
                        All other tasks appear here
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard" id="dashboard" style="display: none;">
        <!-- Briefs Panel -->
        <div class="panel" style="grid-area: briefs;">
            <div class="panel-header">
                <span class="icon">B</span>
                <h2>Briefs</h2>
            </div>
            
            <div class="input-group">
                <input type="text" id="briefTitle" placeholder="Brief title..." onkeypress="handleEnterKey(event, 'brief')">
                <button onclick="addQuickBrief()">
                    Add
                </button>
            </div>

            <div class="scrollable drop-zone" id="briefsList" 
                 ondrop="handleDrop(event, 'brief')" 
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)"
                 data-drop-message="Drop here to create brief">
            </div>
        </div>

        <!-- Tasks Panel -->
        <div class="panel" style="grid-area: tasks;">
            <div class="panel-header">
                <span class="icon">T</span>
                <h2>Tasks</h2>
            </div>

            <div class="input-group">
                <input type="text" id="taskTitle" placeholder="Task title..." onkeypress="handleEnterKey(event, 'task')">
                <button onclick="addQuickTask()">
                    Add
                </button>
            </div>

            <div id="projectTaskContainer" class="scrollable drop-zone" 
                 ondrop="handleDrop(event, 'task')" 
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)"
                 data-drop-message="Drop any item here to create task">
            </div>
        </div>

        <!-- Notes Panel -->
        <div class="panel panel-notes" style="grid-area: notes;">
            <div class="panel-header">
                <span class="icon">N</span>
                <h2>Notes</h2>
            </div>
            
            <div class="input-group">
                <input type="text" id="noteTitle" placeholder="Note title..." onkeypress="handleEnterKey(event, 'note')">
                <button onclick="addQuickNote()">
                    Add
                </button>
            </div>

            <div class="scrollable drop-zone" id="notesList" 
                 ondrop="handleDrop(event, 'note')" 
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)"
                 data-drop-message="Drop brief here to create linked note">
            </div>
        </div>

        <!-- Copy Panel -->
        <div class="panel panel-copy" style="grid-area: copy;">
            <div class="panel-header">
                <span class="icon">C</span>
                <h2>Copy</h2>
            </div>
            
            <div class="input-group">
                <input type="text" id="copyTitle" placeholder="Copy title..." onkeypress="handleEnterKey(event, 'copy')">
                <button onclick="addQuickCopy()">
                    Add
                </button>
            </div>

            <div class="scrollable drop-zone" id="copyList" 
                 ondrop="handleDrop(event, 'copy')" 
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)"
                 data-drop-message="Drop brief here to create linked copy">
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Project</h3>
                <button class="close-btn" onclick="closeModal('projectModal')">√ó</button>
            </div>
            <div class="input-group">
                <input type="text" id="newProjectName" placeholder="Project name...">
            </div>
            <textarea id="newProjectDescription" placeholder="Project description..."></textarea>
            <!-- Import zone will be added here dynamically by JavaScript -->
            <button onclick="createProject()">Create Project</button>
        </div>
    </div>

    <!-- Help Modal -->
<div id="helpModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h2>üìñ Help & User Guide</h2>
            <span class="close" onclick="closeModal('helpModal')">&times;</span>
        </div>
        <div class="modal-body">
            <!-- Quick Start -->
            <section style="margin-bottom: 30px;">
                <h3 style="color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">üöÄ Quick Start</h3>
                <ol style="line-height: 1.6;">
                    <li><strong>Create a Project:</strong> Click "New Project" to start organizing your work</li>
                    <li><strong>Add Briefs:</strong> Create project briefs with propositions and client requirements</li>
                    <li><strong>Develop Ideas:</strong> Drag briefs to create linked notes and copy</li>
                    <li><strong>Create Tasks:</strong> Drag any item to tasks to create actionable items</li>
                    <li><strong>Prioritize:</strong> Use drag & drop to manage your top 3 priority tasks</li>
                </ol>
            </section>

            <!-- Workflow -->
            <section style="margin-bottom: 30px;">
                <h3 style="color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">üîÑ Workflow</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">üìù</div>
                        <strong>Briefs</strong><br>
                        <small>Project requirements & propositions</small>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 8px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">üìì</div>
                        <strong>Notes</strong><br>
                        <small>Ideas & research</small>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fef3c7; border-radius: 8px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">‚úèÔ∏è</div>
                        <strong>Copy</strong><br>
                        <small>Written content</small>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fce7f3; border-radius: 8px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">‚úÖ</div>
                        <strong>Tasks</strong><br>
                        <small>Action items</small>
                    </div>
                </div>
            </section>

            <!-- Drag & Drop -->
            <section style="margin-bottom: 30px;">
                <h3 style="color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">üéØ Drag & Drop</h3>
                <ul style="line-height: 1.8;">
                    <li><strong>Cross-Column Creation:</strong> Drag brief ‚Üí notes/copy to create linked items</li>
                    <li><strong>Task Creation:</strong> Drag any item ‚Üí tasks to create actionable tasks</li>
                    <li><strong>Reordering:</strong> Drag items within the same column to reorder</li>
                    <li><strong>Top Tasks:</strong> Drag tasks to the horizontal priority bar</li>
                    <li><strong>Priority Management:</strong> Use ‚≠ê and √ó buttons to manage top 3 tasks</li>
                </ul>
            </section>

            <!-- Top Tasks System -->
            <section style="margin-bottom: 30px;">
                <h3 style="color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">‚≠ê Top Tasks System</h3>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <p><strong>Global Priority:</strong> Your top 3 tasks appear in both the overview and horizontal bar</p>
                    <ul style="margin: 10px 0; line-height: 1.6;">
                        <li><strong>Horizontal Bar:</strong> Shows top 3 tasks while working on any project</li>
                        <li><strong>Overview Page:</strong> Manage all tasks across projects</li>
                        <li><strong>Synchronized:</strong> Changes in one view instantly update the other</li>
                        <li><strong>Cross-Project:</strong> See important tasks from other projects</li>
                    </ul>
                </div>
            </section>

            <!-- Pomodoro & Focus -->
            <section style="margin-bottom: 30px;">
                <h3 style="color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">üçÖ Pomodoro & Focus</h3>
                <ul style="line-height: 1.8;">
                    <li><strong>Focus Mode:</strong> Available when editing notes or copy</li>
                    <li><strong>Dive In:</strong> Click "Dive In" on tasks to enter focus mode + start timer</li>
                    <li><strong>Fullscreen:</strong> Automatic fullscreen mode during focus sessions</li>
                    <li><strong>Context Preservation:</strong> Work state saved during breaks</li>
                    <li><strong>Session Tracking:</strong> Daily and session counters</li>
                </ul>
            </section>

            <!-- Context & Navigation -->
            <section style="margin-bottom: 30px;">
                <h3 style="color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">üß≠ Context & Navigation</h3>
                <ul style="line-height: 1.8;">
                    <li><strong>Breadcrumbs:</strong> Track your recent work items</li>
                    <li><strong>Work Resumption:</strong> Continue where you left off</li>
                    <li><strong>Auto-save:</strong> Content saved automatically every 1.5 seconds</li>
                    <li><strong>Context Restoration:</strong> Editor state restored when switching back</li>
                </ul>
            </section>

            <!-- Keyboard Shortcuts -->
            <section style="margin-bottom: 20px;">
                <h3 style="color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">‚å®Ô∏è Keyboard Shortcuts</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <!-- General -->
                    <div>
                        <h4 style="color: #374151; margin-bottom: 10px;">General</h4>
                        <table style="width: 100%; font-size: 14px;">
                            <tr><td><kbd>F1</kbd> or <kbd>Ctrl + ?</kbd></td><td>Show this help</td></tr>
                            <tr><td><kbd>Esc</kbd></td><td>Close modals/exit fullscreen</td></tr>
                            <tr><td><kbd>Enter</kbd></td><td>Confirm actions</td></tr>
                            <tr><td><kbd>Ctrl + S</kbd></td><td>Manual save + preserve context</td></tr>
                        </table>
                    </div>

                    <!-- Navigation -->
                    <div>
                        <h4 style="color: #374151; margin-bottom: 10px;">Navigation</h4>
                        <table style="width: 100%; font-size: 14px;">
                            <tr><td><kbd>Alt + B</kbd></td><td>Focus on breadcrumbs</td></tr>
                            <tr><td><kbd>Ctrl + Shift + R</kbd></td><td>Resume last work</td></tr>
                        </table>
                    </div>

                    <!-- Top Tasks -->
                    <div>
                        <h4 style="color: #374151; margin-bottom: 10px;">Top Tasks</h4>
                        <table style="width: 100%; font-size: 14px;">
                            <tr><td><kbd>Ctrl + Alt + 1</kbd></td><td>Promote recent task to top 3</td></tr>
                            <tr><td><kbd>Ctrl + Alt + 2</kbd></td><td>Clear all top 3 tasks</td></tr>
                            <tr><td><kbd>Ctrl + Alt + 3</kbd></td><td>Refresh horizontal tasks</td></tr>
                        </table>
                    </div>

                    <!-- Pomodoro -->
                    <div>
                        <h4 style="color: #374151; margin-bottom: 10px;">Pomodoro (in editor)</h4>
                        <table style="width: 100%; font-size: 14px;">
                            <tr><td><kbd>Space</kbd></td><td>Start/pause timer</td></tr>
                            <tr><td><kbd>Ctrl + R</kbd></td><td>Reset timer</td></tr>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Tips -->
            <section>
                <h3 style="color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">üí° Pro Tips</h3>
                <div style="background: #fef7cd; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <ul style="line-height: 1.8; margin: 0;">
                        <li><strong>Color Coding:</strong> Each brief gets a unique color that flows through linked items</li>
                        <li><strong>Rich Text:</strong> Notes and copy support rich formatting and headings</li>
                        <li><strong>Standard Structure:</strong> Use "Insert Headings" in notes for consistent structure</li>
                        <li><strong>Copy to Clipboard:</strong> Export formatted content with proper styling</li>
                        <li><strong>Project Themes:</strong> Each project has its own color theme</li>
                    </ul>
                </div>
            </section>
        </div>
    </div>
</div>

    <!-- Item Editor Modal -->
    <div id="itemEditor" class="editor-modal">
        <div class="editor-content">
            <div class="editor-header">
                <div style="display: flex; align-items: center; gap: 16px; flex: 1; min-width: 0;">
                    <h3 id="editorTitle" style="margin: 0; white-space: nowrap;">Edit Item</h3>
                </div>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <!-- Pomodoro Timer (only for notes and copy) -->
                    <div id="pomodoroTimer" class="pomodoro-timer" style="display: none;">
                        <div class="pomodoro-display" id="pomodoroDisplay">25:00</div>
                        <div class="pomodoro-status" id="pomodoroStatus">Ready to focus</div>
                        <div class="pomodoro-controls">
                            <button class="pomodoro-btn" id="pomodoroStart" onclick="startPomodoro()">Start</button>
                            <button class="pomodoro-btn" id="pomodoroPause" onclick="pausePomodoro()" style="display: none;">Pause</button>
                            <button class="pomodoro-btn" onclick="resetPomodoro()">Reset</button>
                            <button class="pomodoro-btn" onclick="skipPomodoro()">Skip</button>
                        </div>
                        <div class="pomodoro-stats">
                            <span>Session: <span id="sessionCount">0</span></span>
                            <span>Today: <span id="dailyCount">0</span></span>
                        </div>
                    </div>
                    <button class="close-btn" onclick="closeEditor()">√ó</button>
                </div>
            </div>
            
            <div class="input-group">
                <input type="text" id="editorItemTitle" placeholder="Title...">
            </div>
            
            <!-- Brief-specific fields -->
            <div id="briefFields" style="display: none;">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #171717;">Custom Proposition</label>
                    <textarea id="editorProposition" class="editor-textarea" style="min-height: 150px;" placeholder="Write your custom proposition here..."></textarea>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #171717;">Full Client Brief</label>
                    <!-- CHANGED: This is now a div instead of textarea for rich text support -->
                    <div id="editorClientBrief" class="rich-text-editor" style="min-height: 200px;" placeholder="Paste or write the full client brief here..."></div>
                </div>
            </div>
            
            <!-- Standard content field for other types -->
            <div id="standardFields">
                <div class="editor-toolbar">
                    <button onclick="formatRichText('bold')" title="Bold">B</button>
                    <button onclick="formatRichText('italic')" title="Italic">I</button>
                    <button onclick="formatRichText('formatBlock', 'h1')" title="Heading">H1</button>
                    <button onclick="formatRichText('formatBlock', 'h2')" title="Subheading">H2</button>
                    <button onclick="formatRichText('insertUnorderedList')" title="Bullet List">List</button>
                    <button onclick="formatRichText('insertOrderedList')" title="Numbered List">Numbers</button>
                    <button onclick="createLink()" title="Link">Link</button>
                    <button onclick="formatRichText('removeFormat')" title="Clear Formatting">Clear</button>
                    <!-- Copy to clipboard button for notes and copy -->
                    <button id="copyToClipboardBtn" onclick="copyContentToClipboard()" title="Copy to Clipboard" style="display: none; background: #0891b2; color: white;">
                        Copy
                    </button>
                    <!-- Insert Headings button for notes -->
                    <button id="insertHeadingsBtn" onclick="insertStandardHeadings()" title="Insert Standard Prompts" style="display: none; background: #16a34a; color: white;">
                        Prompts
                    </button>
                </div>
                
                <div id="richEditor" class="rich-editor" contenteditable="true" placeholder="Start writing... (Use the toolbar above for formatting)"></div>
                <textarea id="editorContent" class="editor-textarea" placeholder="Content..." style="display: none;"></textarea>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 20px; align-items: center;">
                <div id="autosaveStatus" style="flex: 1; font-size: 12px; color: #737373;">
                    <span id="autosaveText">Ready</span>
                </div>
                <button onclick="closeEditor()" class="btn-secondary">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Project Settings Modal -->
    <div id="projectSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Project Settings</h3>
                <button class="close-btn" onclick="closeModal('projectSettingsModal')">√ó</button>
            </div>
            <div class="input-group">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #171717;">Project Name</label>
                <input type="text" id="settingsProjectName" placeholder="Project name...">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #171717;">Color Theme</label>
                <select id="settingsColorTheme">
                    <option value="blue">Blue</option>
                    <option value="green">Green</option>
                    <option value="purple">Purple</option>
                    <option value="pink">Pink</option>
                    <option value="orange">Orange</option>
                    <option value="teal">Teal</option>
                    <option value="indigo">Indigo</option>
                    <option value="red">Red</option>
                </select>
            </div>
            <!-- ADDED: Export button and improved layout -->
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button onclick="saveProjectSettings()" style="flex: 1;">Save Settings</button>
                <button onclick="exportProjectAsWord()" style="background: #16a34a; color: white; flex: 1;">üìÑ Export as Word</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirmTitle">Confirm Action</h3>
            </div>
            <div id="confirmMessage" style="margin: 20px 0; font-size: 16px;">
                Are you sure you want to proceed?
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="cancelConfirm()" class="btn-secondary">
                    Cancel
                </button>
                <button onclick="proceedConfirm()" style="background: #dc2626;">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
